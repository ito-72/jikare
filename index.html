<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Work Planner</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="container">
    <h1>Work Planner</h1>

    <div class="grid cols-2">
      <!-- ====== 左：投稿フォーム ====== -->
      <section class="card" id="postCard">
        <h2 class="sec-title">予定の書き込み（既存）</h2>

        <div class="rows">
          <!-- 年月日：1行3カラム（ラベルの下に入力欄） -->
          <div class="row row-inline-3">
            <div class="fgroup">
              <label for="year">年</label>
              <input id="year" type="number" inputmode="numeric" placeholder="2025" />
            </div>
            <div class="fgroup">
              <label for="month">月</label>
              <input id="month" type="number" inputmode="numeric" placeholder="9" />
            </div>
            <div class="fgroup">
              <label for="day">日</label>
              <input id="day" type="number" inputmode="numeric" placeholder="14" />
            </div>
          </div>

          <div class="row">
            <div class="fgroup">
              <label for="time">時刻</label>
              <input id="time" type="time" />
            </div>
          </div>

          <div class="row">
            <div class="fgroup">
              <label for="task">内容</label>
              <textarea id="task" rows="3" placeholder="タスク内容"></textarea>
            </div>
          </div>

          <!-- ユーザー：タブ切替（篤志/千尋） -->
          <div class="row">
            <div class="fgroup">
              <label>ユーザー</label>
              <div class="tabs" id="userTabs">
                <button type="button" data-user="atsushi" class="active">篤志</button>
                <button type="button" data-user="chihiro">千尋</button>
              </div>
            </div>
          </div>

          <div class="actions">
            <button id="btnPost" class="primary" type="button">書き込む</button>
            <span id="postStatus" class="muted"></span>
          </div>
        </div>
      </section>

      <!-- ====== 右：閲覧ビュー（見出しテキストは削除） ====== -->
      <section id="viewer" class="card">
        <!-- 1行ナビ：Prev / Today / Next / Week・Month / 日付 / Refresh -->
        <div class="viewerbar">
          <button id="btnPrev" type="button">Prev</button>
          <button id="btnToday" type="button">Today</button>
          <button id="btnNext" type="button">Next</button>

          <div class="seg">
            <label><input type="radio" name="viewmode" value="week" checked>Week</label>
            <label><input type="radio" name="viewmode" value="month">Month</label>
          </div>

          <input id="datePicker" type="date" />
          <button id="btnRefresh" type="button">Refresh</button>
        </div>

        <div id="rangeLabel" class="muted"></div>

        <div class="table-wrap">
          <table id="rowsTable">
            <thead id="rowsThead"></thead>
            <tbody id="rowsTbody"></tbody>
          </table>
        </div>

        <div id="viewerStatus" class="muted" style="margin-top:6px;"></div>
      </section>
    </div>
  </div>

  <!-- ====== Post（既存書き込み） ====== -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);
      const el = {
        year: $('year'), month: $('month'), day: $('day'),
        time: $('time'), task: $('task'),
        btnPost: $('btnPost'), postStatus: $('postStatus'),
        userTabs: $('userTabs')
      };

      // User tabs
      let currentUser = 'atsushi';
      el.userTabs.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button[data-user]');
        if(!btn) return;
        currentUser = btn.dataset.user;
        [...el.userTabs.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b===btn));
      });

      // defaults: today
      const now = new Date();
      el.year.value = now.getFullYear();
      el.month.value = now.getMonth()+1;
      el.day.value = now.getDate();

      el.btnPost.addEventListener('click', async ()=>{
        el.postStatus.textContent = '送信中...';
        try{
          const payload = {
            year: Number(el.year.value),
            month: Number(el.month.value),
            day: Number(el.day.value),
            time: el.time.value || "",
            task: el.task.value || "",
            user: currentUser
          };
          const res = await fetch('/api/postTask', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          const text = await res.text();
          el.postStatus.textContent = text || '完了';
          if (window.viewerLoadRows) window.viewerLoadRows(); // 書き込み後に再読込
        }catch(err){
          console.error(err);
          el.postStatus.textContent = '❌ ' + err.message;
        }
      });
    })();
  </script>

  <!-- ====== Viewer（週／月一覧） ====== -->
  <script>
    (function(){
      // 公開：外部から手動更新したいときに使用
      window.viewerLoadRows = loadRows;

      const fmt = (d)=> {
        const z=n=>String(n).padStart(2,'0');
        return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
      };

      const $ = (id)=>document.getElementById(id);
      const el = {
        btnPrev: $('btnPrev'), btnToday: $('btnToday'), btnNext: $('btnNext'),
        datePicker: $('datePicker'), btnRefresh: $('btnRefresh'),
        rangeLabel: $('rangeLabel'), thead: $('rowsThead'), tbody: $('rowsTbody'), status: $('viewerStatus')
      };

      const today = new Date();
      let centerDate = new Date(today);
      let view = 'week';

      el.datePicker.value = fmt(today);

      function getWeekRange(center){
        const s = new Date(center); s.setDate(s.getDate()-7);
        const e = new Date(center); e.setDate(e.getDate()+7);
        return {start:s, end:e};
      }
      function getMonthYm(center){ return {y:center.getFullYear(), m:center.getMonth()+1}; }

      function setRangeLabelWeek(s,e){ el.rangeLabel.textContent = `Week: ${fmt(s)} 〜 ${fmt(e)}`; }
      function setRangeLabelMonth(y,m){ el.rangeLabel.textContent = `Month: ${y}年${m}月`; }

      function renderTable(headers, rows){
        el.thead.innerHTML = '';
        const trh = document.createElement('tr');
        (headers||[]).forEach(h=>{ const th=document.createElement('th'); th.textContent=h||''; trh.appendChild(th); });
        el.thead.appendChild(trh);

        el.tbody.innerHTML = '';
        (rows||[]).forEach(r=>{
          const tr=document.createElement('tr');
          r.forEach(c=>{ const td=document.createElement('td'); td.textContent=(c==null)?'':String(c); tr.appendChild(td); });
          el.tbody.appendChild(tr);
        });
      }

      async function loadRows(){
        el.status.textContent = '読込中…';
        try{
          let url = '/api/getRows?';
          if(view==='week'){
            const {start,end} = getWeekRange(centerDate);
            setRangeLabelWeek(start,end);
            url += new URLSearchParams({view:'week', startDate:fmt(start), endDate:fmt(end), range:'A:G', limit:'0'}).toString();
          }else{
            const {y,m} = getMonthYm(centerDate);
            setRangeLabelMonth(y,m);
            url += new URLSearchParams({view:'month', year:String(y), month:String(m), range:'A:G', limit:'0'}).toString();
          }
          const res = await fetch(url);
          const json = await res.json().catch(()=> ({}));
          if(!json || !json.ok) throw new Error(json && json.error ? json.error : '不明なエラー');
          renderTable(json.headers||[], json.rows||[]);
          el.status.textContent = `${(json.rows||[]).length} 行`;
        }catch(err){
          console.error(err);
          el.status.textContent = '❌ ' + err.message;
          renderTable([],[]);
        }
      }

      // ナビ
      el.btnPrev.addEventListener('click', ()=>{
        if(view==='week') centerDate.setDate(centerDate.getDate()-7);
        else centerDate.setMonth(centerDate.getMonth()-1);
        el.datePicker.value = fmt(centerDate);
        loadRows();
      });
      el.btnToday.addEventListener('click', ()=>{
        centerDate = new Date();
        el.datePicker.value = fmt(centerDate);
        loadRows();
      });
      el.btnNext.addEventListener('click', ()=>{
        if(view==='week') centerDate.setDate(centerDate.getDate()+7);
        else centerDate.setMonth(centerDate.getMonth()+1);
        el.datePicker.value = fmt(centerDate);
        loadRows();
      });
      el.btnRefresh.addEventListener('click', loadRows);

      // Week/Month
      document.querySelectorAll('input[name="viewmode"]').forEach(r=>{
        r.addEventListener('change', (e)=>{ view = e.target.value; loadRows(); });
      });

      // 日付ジャンプ
      el.datePicker.addEventListener('change', (e)=>{
        if(e.target.value){ centerDate = new Date(e.target.value); loadRows(); }
      });

      // 初回
      loadRows();
    })();
  </script>
</body>
</html>
